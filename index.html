<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Car</title>
    <style>
      canvas {
        position: absolute;
        top: 0;
        left: 0;
      }
      .scene {
        position: absolute;
        top: 0;
        left: 0;
      }

      #car {
        position: absolute;
        top: -8px;
        left: -4px;
        width: 8px;
        height: 16px;
        background-color: #f60;
      }
    </style>
  </head>
  <body>
    <canvas></canvas>
    <div class="scene">
      <div id="car"></div>
    </div>
    <script>
      let windowWidth = window.innerWidth;
      let windowHeight = window.innerHeight;
  
      const canvas = document.getElementsByTagName('canvas')[0];
      const ctx = canvas.getContext('2d');

      const car = document.getElementById('car');

      const maxPower = 0.0375;
      const maxBrakingPower = 0.01875;
      const powerFactor = 0.0001;
      const brakingFactor = 0.0002;

      const drag = 0.95;
      const angularDrag = 0.98;
      const turnSpeed = 0.0004;

      let power = 0;
      let brakingPower = 0;

      let positionX = windowWidth / 2;
      let positionY = windowHeight / 2;

      let velocityX = 0;
      let velocityY = 0;

      let angle = 0;
      let angularVelocity = 0;

      const keysDown = {};

      window.addEventListener('keydown', e => {
        keysDown[e.which] = true;
      });

      window.addEventListener('keyup', e => {
        keysDown[e.which] = false;
      });

      setInterval(() => {
        if (keysDown[38]) {
          power += powerFactor;
        } else {
          power -= powerFactor * 2;
        }
        if (keysDown[40]) {
          brakingPower += brakingFactor;
        } else {
          brakingPower -= brakingFactor * 2;
        }

        power = Math.max(0, Math.min(maxPower, power));
        brakingPower = Math.max(0, Math.min(maxBrakingPower, brakingPower));

        const direction = power > brakingPower ? 1 : -1;

        if (power || brakingPower) {
          if (keysDown[37]) {
            angularVelocity -= direction * turnSpeed;
          }
          if (keysDown[39]) {
            angularVelocity += direction * turnSpeed;
          }
        }

        velocityX += Math.sin(angle) * (power - brakingPower);
        velocityY += Math.cos(angle) * (power - brakingPower);

        positionX += velocityX;
        positionY -= velocityY;
        velocityX *= drag;
        velocityY *= drag;
        angle += angularVelocity;
        angularVelocity *= angularDrag;

        if (positionX > windowWidth) {
          positionX -= windowWidth;
        } else if (positionX < 0) {
          positionX += windowWidth;
        }

        if (positionY > windowHeight) {
          positionY -= windowHeight;
        } else if (positionY < 0) {
          positionY += windowHeight;
        }
      }, 1 / 30);

      function render () {
        requestAnimationFrame(render);

        car.style.transform = `translate(${positionX}px, ${positionY}px) rotate(${angle * 180 / Math.PI}deg)`;

        if (power || brakingPower) {
          ctx.save();
          ctx.translate(positionX - Math.cos(angle) * 4, positionY - Math.sin(angle) * 4);
          ctx.rotate(angle);
          ctx.translate(-positionX, -positionY);
          ctx.fillRect(
            positionX,
            positionY, 
            1, 
            1
          );
          ctx.restore();

          ctx.save();
          ctx.translate(positionX - Math.cos(Math.PI + angle) * 4, positionY - Math.sin(Math.PI + angle) * 4);
          ctx.rotate(angle);
          ctx.translate(-positionX, -positionY);
          ctx.fillRect(
            positionX,
            positionY,
            1,
            1
          );
          ctx.restore();
        }
      }

      render();

      function resize () {
        windowWidth = window.innerWidth;
        windowHeight = window.innerHeight;

        canvas.width = windowWidth;
        canvas.height = windowHeight;

        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
      }

      resize();

      window.addEventListener('resize', resize);
    </script>
  </body>
</html>